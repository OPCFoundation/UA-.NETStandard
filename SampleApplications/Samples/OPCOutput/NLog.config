<?xml version="1.0" encoding="utf-8" ?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <!-- make sure to set 'Copy To Output Directory' option for this file -->
  <!-- go to http://nlog-project.org/wiki/Configuration_file for more information -->

  <targets>
    <!--<targets async="true">-->
    <!--The following will keep the default number of log messages in a buffer and write out certain levels if there is an error and
        other levels if there is not. Messages that appeared before the error (in code) will be included, since they are buffered.-->
    <wrapper-target xsi:type="BufferingWrapper" name="smartLog">
      <wrapper-target xsi:type="PostFilteringWrapper">

        <target name="simpleMessageTarget" xsi:type="File" fileName="${basedir}/Logs/Application.log"
                      archiveFileName="${basedir}/Logs/archives/Application.{#####}.log"
                      archiveAboveSize="1048576" archiveNumbering="Sequence" concurrentWrites="false" maxArchiveFiles="10" >

          <layout xsi:type="CsvLayout" delimiter="Space" withHeader="false">
            <column name="Time" layout="${longdate}" />
            <column name="Machinename" layout="${machinename}" />
            <column name="Level" layout="${level:upperCase=true}"/>
            <column name="Message" layout="${message}${onexception:inner=${newline}${exception:format=Message}}" />
            <column name="Logger" layout="${onexception:EXCEPTION OCCURRED\:${exception:format=ToString,StackTrace:maxInnerExceptionLevel=5}}"/>
          </layout>
        </target>
      </wrapper-target>
    </wrapper-target>

    <wrapper-target xsi:type="BufferingWrapper" name="smartLog">
      <wrapper-target xsi:type="PostFilteringWrapper">

        <target name="errorMessageTarget" xsi:type="File" fileName="${basedir}/Logs/Application.log"
                      archiveFileName="${basedir}/Logs/archives/Application.{#####}.log"
                      archiveAboveSize="1048576" archiveNumbering="Sequence" concurrentWrites="false" maxArchiveFiles="10" >

          <layout xsi:type="CsvLayout" delimiter="Space" withHeader="false">
            <column name="Time" layout="${longdate}" />
            <column name="Machinename" layout="${machinename}" />
            <column name="Level" layout="${level:upperCase=true}"/>
            <column name="Message" layout="${message}" />
            <column name="Stacktrace" layout="${stacktrace:topFrames=10}" />
          </layout>
        </target>
        <!--if there is at least one error, log everything from trace level-->
        <when exists="level >= LogLevel.Error" filter="level >= LogLevel.Trace" />
      </wrapper-target>
    </wrapper-target>
  </targets>

  <rules>
    <logger name="*" writeTo="simpleMessageTarget" minlevel="Trace" maxLevel="Warn" />
    <logger name="*" minlevel="Error" writeTo="ErrorMessageTarget" />
  </rules>
</nlog>
